<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 📡 802.11g 发射机 | 调试与测试 · PA's Blog</title><meta name="description" content="📡 802.11g 发射机 | 调试与测试 - Puzzled Alex"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://pa.radonyl.xyz/atom.xml" title="PA's Blog"><meta name="generator" content="Hexo 4.0.0"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/alalelel" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">📡 802.11g 发射机 | 调试与测试</h1><div class="post-info">Dec 1, 2019</div><div class="post-content"><p>分模块设计完成后，需要进行组装和调试。按照框图将模块级联，接下来对模块的时序、数据完整性和数据正确性在仿真层面上进行验证。仿真验证通过后，将所有的模块打包成Tx80211自定义IP核，加入AD9361的IP核Block Design，进行接下来的板上验证。<br><img src="https://raw.githubusercontent.com/radonyl/pa_blog_img/master/img/31512-draft-bd" alt="31512-draft-bd"></p>
<h1 id="发射机Modelsim仿真验证"><a href="#发射机Modelsim仿真验证" class="headerlink" title="发射机Modelsim仿真验证"></a>发射机Modelsim仿真验证</h1><p>首先使用matlab构造802.11g数据包，导出基带二进制流和生成好的基带信号。将matlab的基带二进制流储存在Tx_Ram中，并编写testbench，接下来在modelsim中进行基带数据生成器的全仿真。通过Modelsim观察并导出生成的波形，再将生成的波形与Matlab生成的标准数据进行比较。</p>
<h4 id="Testbench"><a href="#Testbench" class="headerlink" title="Testbench"></a>Testbench</h4><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">wire</span> [<span class="number">23</span>:<span class="number">0</span>] SIGNAL;</span><br><span class="line"><span class="keyword">reg</span> [<span class="number">31</span>:<span class="number">0</span>] ram_addr = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">wire</span> [<span class="number">7</span>:<span class="number">0</span>] DATA;</span><br><span class="line">tx_ram TxRam(</span><br><span class="line">    <span class="variable">.addr</span>(ram_addr),</span><br><span class="line">    <span class="variable">.SIGNAL</span>(SIGNAL),</span><br><span class="line">    <span class="variable">.DATA</span>(fifo_din)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">initial</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    sim_idx = <span class="number">0</span>;</span><br><span class="line">    # <span class="number">40000</span>; <span class="comment">// wait clock to lock</span></span><br><span class="line">    <span class="keyword">repeat</span>(<span class="number">2</span>) <span class="keyword">begin</span></span><br><span class="line">        @(<span class="keyword">posedge</span> clk)</span><br><span class="line">        s_config_tdata[<span class="number">23</span>:<span class="number">0</span>] = SIGNAL;</span><br><span class="line">        s_config_tvalid      = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (idx = <span class="number">0</span>; idx &lt; <span class="number">66</span>; idx = idx + <span class="number">1</span>) <span class="keyword">begin</span></span><br><span class="line">            ram_addr   = idx;</span><br><span class="line">            fifo_wr_en = <span class="number">1</span>;</span><br><span class="line">            @(<span class="keyword">posedge</span> clk);</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        fifo_wr_en = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (busy) @(<span class="keyword">posedge</span> clk);</span><br><span class="line">        @(<span class="keyword">posedge</span> clk);</span><br><span class="line">        tx_now = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">repeat</span>(<span class="number">20</span>) @(<span class="keyword">posedge</span> clk);</span><br><span class="line">        tx_now = <span class="number">0</span>;</span><br><span class="line">        # <span class="number">2000</span></span><br><span class="line">        <span class="keyword">while</span> (tx_data_valid) @(<span class="keyword">posedge</span> clk);</span><br><span class="line">        sim_idx = sim_idx + <span class="number">1</span>;</span><br><span class="line">        # <span class="number">10000</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="built_in">$finish</span>;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h4 id="Tx-Ram-节选"><a href="#Tx-Ram-节选" class="headerlink" title="Tx Ram(节选)"></a>Tx Ram(节选)</h4><p>用于储存发射二进制基带数据的Verilog文件，由matlab导出的二进制流数据生成。<br><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> tx_ram(<span class="keyword">input</span> [<span class="number">31</span>:<span class="number">0</span>] addr,</span><br><span class="line">              <span class="keyword">output</span> <span class="keyword">reg</span> [<span class="number">23</span>:<span class="number">0</span>] SIGNAL,</span><br><span class="line">              <span class="keyword">output</span> <span class="keyword">reg</span> [<span class="number">7</span>:<span class="number">0</span>] DATA);</span><br><span class="line">    <span class="keyword">reg</span> [<span class="number">7</span>:<span class="number">0</span>] data_ram [<span class="number">100</span>:<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">integer</span> i;</span><br><span class="line">    <span class="keyword">initial</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="comment">// zeroing ram</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">101</span>; i = i + <span class="number">1</span>)</span><br><span class="line">            data_ram[i] = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// load data</span></span><br><span class="line">        <span class="comment">// generated at Sat Nov 23 17:41:48 2019 from file: E:\matlab_bb.txt</span></span><br><span class="line">        SIGNAL = <span class="number">24'b000000000000100000001011</span>; <span class="comment">// Rate:1101 Len:64</span></span><br><span class="line">        data_ram[<span class="number">0</span>] = <span class="number">0'b00000000</span>; <span class="comment">// 0x00</span></span><br><span class="line">        data_ram[<span class="number">1</span>] = <span class="number">0'b00000000</span>; <span class="comment">// 0x00</span></span><br><span class="line">        data_ram[<span class="number">2</span>] = <span class="number">8'b10000000</span>; <span class="comment">// 0x80</span></span><br><span class="line">        data_ram[<span class="number">3</span>] = <span class="number">8'b00000010</span>; <span class="comment">// 0x02</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        data_ram[<span class="number">62</span>] = <span class="number">8'b00111110</span>; <span class="comment">// 0x3e</span></span><br><span class="line">        data_ram[<span class="number">63</span>] = <span class="number">8'b10101010</span>; <span class="comment">// 0xaa</span></span><br><span class="line">        data_ram[<span class="number">64</span>] = <span class="number">8'b11101111</span>; <span class="comment">// 0xef</span></span><br><span class="line">        data_ram[<span class="number">65</span>] = <span class="number">8'b10111100</span>; <span class="comment">// 0xbc</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">always</span> @(*) <span class="keyword">begin</span></span><br><span class="line">        DATA = data_ram[addr];</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></table></figure></p>
<h4 id="Modelsim-基带数据全仿真结果"><a href="#Modelsim-基带数据全仿真结果" class="headerlink" title="Modelsim 基带数据全仿真结果"></a>Modelsim 基带数据全仿真结果</h4><p>设置modelsim捕捉各模块信号，按照扰码-&gt;卷积编码-&gt;交织-&gt;星座映射-&gt;添加导频-&gt;IFFT-&gt;加窗的顺序排列信号，观察信号传递时序是否正确，数据是否完整。<br>将<br><img src="https://raw.githubusercontent.com/radonyl/pa_blog_img/master/img/bb-signal-gen-modelsim-total-1" alt="bb-signal-gen-modelsim-total-1"></p>
<h4 id="基带信号发生器与Matlab标准数据对比"><a href="#基带信号发生器与Matlab标准数据对比" class="headerlink" title="基带信号发生器与Matlab标准数据对比"></a>基带信号发生器与Matlab标准数据对比</h4><p>将数据导出后与matlab生成的标准发射信号进行对比，由于需要对比的数据量较多，使用Python编写了自动比较脚本，其输出结果如下：</p>
<p><img src="https://raw.githubusercontent.com/radonyl/pa_blog_img/master/img/abs-diff-bb-vhdl-vs-matlab" alt="abs-diff-bb-vhdl-vs-matlab"></p>
<p>结果显示：基带信号发生器产生的发射信号误差在允许范围内，且无错误。</p>
<h1 id="发射机板上验证"><a href="#发射机板上验证" class="headerlink" title="发射机板上验证"></a>发射机板上验证</h1><p>在通过了Modelsim仿真验证后，将HDL工程综合后添加ILA核，添加相应的信号观察，布线后烧录在FPGA板上。此时Testbench实际上是ZYNQ7处理器中运行的程序，数据通过AXI总线写入Tx80211发射机IP核中的FIFO中，写入完毕后由ZYNQ7发出发射指令。通过设置ILA核触发信号，可定向捕捉所需信号，导出信号后与Matlab产生的标准信号进行对比。在上板调试中发现了之前仿真过程中没有发现的问题，详见下文。</p>
<p>在修正完所有Bug后，将最后的数据导出并与Matlab数据进行比较：</p>
<p><img src="https://raw.githubusercontent.com/radonyl/pa_blog_img/master/img/abs-diff-bb-ila-vs-matlab" alt="abs-diff-bb-ila-vs-matlab"></p>
<p>结果显示：基带信号发生器实际产生的发射信号误差在允许范围内，且无错误。</p>
<h1 id="调试中遇到的问题"><a href="#调试中遇到的问题" class="headerlink" title="调试中遇到的问题"></a>调试中遇到的问题</h1><h4 id="1-卷积编码器帧同步置零问题"><a href="#1-卷积编码器帧同步置零问题" class="headerlink" title="1.卷积编码器帧同步置零问题"></a>1.卷积编码器帧同步置零问题</h4><p><strong>问题现象</strong>:<br>板上调试发现基带数据生成器中，卷积编码器输出的最初6个值与理论不符合，如图所示，其中红色为正确输出。</p>
<p><img src="https://raw.githubusercontent.com/radonyl/pa_blog_img/master/img/problem-conv-encoder-not-reset" alt="problem-conv-encoder-not-reset"></p>
<p><strong>问题分析</strong><br>经过对比，发现有且仅有最初6个数据与理论不符合，且稳定复现。考虑到卷积编码移位寄存器深度恰好等于6，逆推得到开始卷积前移位寄存器的值应为010110，恰好为上一次基带信号的最后6位。于是得出结论：卷积编码器在处理完一帧数据后没有重置，导致了问题。<br><strong>问题解决</strong><br><img src="https://raw.githubusercontent.com/radonyl/pa_blog_img/master/img/code-conv-encoder-fix-1" alt="code-conv-encoder-fix-1"><br>将卷积编码器的重置与帧开始信号同步，保证在处理每一帧数据前卷积编码器均处于全0状态。</p>
<h4 id="2-数据域Tail无需扰码需要置零的问题"><a href="#2-数据域Tail无需扰码需要置零的问题" class="headerlink" title="2.数据域Tail无需扰码需要置零的问题"></a>2.数据域Tail无需扰码需要置零的问题</h4><p><strong>问题现象</strong><br>板上调试发现，输出的基带数据最后一个Symbol错误，而之前的所有symbol完全正确。<br><img src="https://raw.githubusercontent.com/radonyl/pa_blog_img/master/img/problem-tail-not-zeroed" alt="problem-tail-not-zeroed"><br><strong>问题分析</strong><br>仔细查看802.11协议，在附录G.1发现如下描述：<br><img src="https://raw.githubusercontent.com/radonyl/pa_blog_img/master/img/zeroing-tail-bits-desc" alt="zeroing-tail-bits-desc"><br>按照协议，在数据域最后6bit的Tail无需进行扰码，需要置零。而在基带信号生成器中没有考虑到这一点，导致最后一个Symbol发生错误。<br><strong>问题解决</strong><br><img src="https://raw.githubusercontent.com/radonyl/pa_blog_img/master/img/tail-not-zeroed-fix-1" alt="tail-not-zeroed-fix-1"><br>在扰码器模块中添加计数器，同时将计数器与SIGNAL Field的LENGTH进行比较，从而将相应的Tail bits置零。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2019/11/10/802-11g-Transmitter-10-app-programming/" class="next">NEXT</a></div><div class="copyright"><p>© 2019 <a href="http://pa.radonyl.xyz">Puzzled Alex</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>